# ZSH Configuration

# Detect OS
{{- if eq .chezmoi.os "darwin" }}
export OS_TYPE="macos"
{{- else }}
export OS_TYPE="linux"
{{- end }}

# =============================================================================
# Path
# =============================================================================

{{- if eq .chezmoi.os "darwin" }}
[[ -f "/opt/homebrew/bin/brew" ]] && eval "$(/opt/homebrew/bin/brew shellenv)"
[[ -f "/usr/local/bin/brew" ]] && eval "$(/usr/local/bin/brew shellenv)"
{{- else }}
[[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]] && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{- end }}

export PATH="$HOME/.local/bin:$HOME/bin:$PATH"
export PATH="$HOME/go/bin:$PATH"
{{- if eq .chezmoi.os "darwin" }}
export PATH="$HOME/Library/Python/3.9/bin:$PATH"
{{- end }}

# =============================================================================
# Environment
# =============================================================================

export EDITOR="nvim"
export VISUAL="nvim"
export LANG="en_US.UTF-8"
export HISTSIZE=50000
export SAVEHIST=50000
export HISTFILE="$HOME/.zsh_history"
export HOMEBREW_NO_ENV_HINTS=1

# Fix terminal type for SSH sessions (Ghostty terminfo not available on remote)
if [[ -n "$SSH_CONNECTION" ]] && [[ "$TERM" == "xterm-ghostty" ]]; then
  export TERM="xterm-256color"
fi

# =============================================================================
# Secrets (via 1Password)
# Run 'chezmoi apply' after 'op signin' to populate
# =============================================================================

{{ if stat (joinPath .chezmoi.homeDir ".config/op/config") -}}
{{ $geminiKey := onepasswordRead "op://Development/Gemini API/credential" -}}
export GOOGLE_API_KEY="{{ $geminiKey }}"
{{- end }}

# =============================================================================
# AI / Claude Configuration
# =============================================================================

export GEMINI_MODEL="gemini-2.5-pro"
export GEMINI_MODEL_FAST="gemini-2.5-flash"

# Vertex AI (Claude)
export CLAUDE_CODE_USE_VERTEX=1
export ANTHROPIC_VERTEX_PROJECT_ID="ai-automat-id-play-38355"
export ANTHROPIC_VERTEX_REGION="europe-west1"
export CLOUD_ML_REGION="europe-west1"
export CLOUDSDK_PYTHON_SITEPACKAGES=1

# PAI (Personal AI Infrastructure)
export PAI_DIR="$HOME/.claude"
export DA="Basic"
export DA_COLOR="purple"
export ENGINEER_NAME="{{ .name }}"

# =============================================================================
# Options
# =============================================================================

setopt HIST_IGNORE_ALL_DUPS SHARE_HISTORY AUTO_CD CORRECT

# =============================================================================
# Completion
# =============================================================================

autoload -Uz compinit && compinit
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' menu select

# =============================================================================
# Key Bindings
# =============================================================================

bindkey -e
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward

# Fix backspace and delete
bindkey '^?' backward-delete-char
bindkey '^[[3~' delete-char
bindkey '^H' backward-delete-char

# =============================================================================
# Aliases
# =============================================================================

alias ..="cd .."
alias ...="cd ../.."
alias ls="ls --color=auto"
alias ll="ls -lah"
alias la="ls -la"
alias v="nvim"
alias vim="nvim"
alias c="clear"
alias reload="source ~/.zshrc"

# Git
alias g="git"
alias gs="git status"
alias ga="git add"
alias gc="git commit"
alias gp="git push"
alias gl="git pull"
alias gd="git diff"
alias glog="git log --oneline --graph --decorate"

# tmux
alias t="tmux"
alias ta="tmux attach -t"
alias tn="tmux new -s"
alias tl="tmux list-sessions"

# Claude
alias b="claude"
alias b-i="claude --dangerously-skip-permissions"

{{- if eq .chezmoi.os "darwin" }}
alias brewup="brew update && brew upgrade && brew cleanup"
command -v gls &> /dev/null && alias ls="gls --color=auto"
{{- else }}
alias open="xdg-open"
{{- end }}

# Markdown (full width display)
alias glow='glow -w $(tput cols)'

# =============================================================================
# Functions
# =============================================================================

mkcd() { mkdir -p "$1" && cd "$1"; }

# Open most recently modified markdown file
glast() {
  local latest=$(ls -t *.md 2>/dev/null | head -1)
  if [[ -n "$latest" ]]; then
    glow "$latest"
  else
    echo "No markdown files found in current directory"
  fi
}

# Open markdown in browser with GitHub-style rendering
mdview() {
  local pid=$(lsof -ti:6419 2>/dev/null)
  [[ -n "$pid" ]] && kill $pid 2>/dev/null && sleep 0.5

  if [[ -f "$1" ]]; then
    echo "Opening $1 in browser..."
    echo "Server running at http://localhost:6419"
    echo "Press Ctrl+C to stop"
    grip "$1" --browser --quiet
  else
    echo "Usage: mdview <file.md>"
  fi
}

# Open most recent markdown in browser
mdlast() {
  local pid=$(lsof -ti:6419 2>/dev/null)
  [[ -n "$pid" ]] && kill $pid 2>/dev/null && sleep 0.5

  local latest=$(ls -t *.md 2>/dev/null | head -1)
  if [[ -n "$latest" ]]; then
    echo "Opening $latest in browser..."
    echo "Server running at http://localhost:6419"
    echo "Press Ctrl+C to stop"
    grip "$latest" --browser --quiet
  else
    echo "No markdown files found in current directory"
  fi
}

# Fabric deep research
deep() {
  echo "$1" | fabric -m deep-research-pro-preview-12-2025 --pattern extract_wisdom
}

# INWX CLI wrapper (credentials from 1Password)
{{- if eq .chezmoi.os "darwin" }}
inwx() {
  if command -v op &> /dev/null; then
    inwxcli \
      --username "$(op read 'op://Development/INWX/username')" \
      --password "$(op read 'op://Development/INWX/password')" \
      "$@"
  else
    echo "1Password CLI not available"
  fi
}

# SSH to ai-console via Tailscale
ai-console() {
  ssh ai-console
}

# Mutagen sync management for ai-console
ai-console-sync() {
  local action="${1:-status}"
  local session_name="ai-console"

  case "$action" in
    start)
      echo "Starting mutagen sync to ai-console..."
      mutagen sync create \
        ~/Projects \
        ai-console:~/Projects \
        --name="$session_name" \
        --ignore=".git,node_modules,.DS_Store,*.pyc,__pycache__" \
        --sync-mode=two-way-resolved
      ;;
    stop)
      mutagen sync terminate "$session_name"
      ;;
    status)
      mutagen sync list "$session_name"
      ;;
    monitor)
      mutagen sync monitor "$session_name"
      ;;
    *)
      echo "Usage: ai-console-sync {start|stop|status|monitor}"
      echo "  start   - Start mutagen sync"
      echo "  stop    - Stop mutagen sync"
      echo "  status  - Show sync status (default)"
      echo "  monitor - Monitor sync in real-time"
      ;;
  esac
}
{{- end }}

# =============================================================================
# Tools
# =============================================================================

# FZF
if command -v fzf &> /dev/null; then
  command -v fd &> /dev/null && export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_DEFAULT_OPTS="--color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8 \
    --color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc \
    --color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8"
  {{- if eq .chezmoi.os "darwin" }}
  [[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh
  {{- end }}
fi

# Zoxide
command -v zoxide &> /dev/null && eval "$(zoxide init zsh)" && alias cd="z"

# ZSH plugins
{{- if eq .chezmoi.os "darwin" }}
[[ -f "$(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]] && \
  source "$(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
[[ -f "$(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]] && \
  source "$(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
{{- end }}

# Bun completions
[[ -s "$HOME/.bun/_bun" ]] && source "$HOME/.bun/_bun"

# Auto-start tmux session
if command -v tmux &> /dev/null && [[ -z "$TMUX" ]] && [[ $- == *i* ]]; then
  tmux new-session -A -s local-ai
fi

# Starship prompt (load last)
command -v starship &> /dev/null && eval "$(starship init zsh)"

# Local overrides (not managed by chezmoi)
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

{{- if eq .chezmoi.os "linux" }}
# SSH agent
[[ -z "$SSH_AUTH_SOCK" ]] && eval "$(ssh-agent -s)" > /dev/null 2>&1
{{- end }}
